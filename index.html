<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kokosima AI - Katalog Prompt Cinematic</title>
    <meta name="description" content="Koleksi prompt AI Cinematic gratis untuk Midjourney, Dall-E, dan Stable Diffusion.">
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">  
</head>
<body>

<header class="top-bar">
    <a href="index.html" class="logo-link">
		<span class="brain-icon">üß†</span>
		<span class="logo-text">kokosima</span>
	</a>
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="Cari (hutan, robot, neon...)" autocomplete="off">
    </div>
    <div class="social-links">
        <a href="https://www.facebook.com/chochoshima/" target="_blank">Facebook</a>
        <a href="https://www.youtube.com/@kokosimaabsurd/" target="_blank">YouTube</a>
		<div class="language-selector">
			<button class="lang-btn active" onclick="setLanguage('id')">ID</button>
			<span class="lang-divider">|</span>
			<button class="lang-btn" onclick="setLanguage('en')">EN</button>
		</div>
    </div>
</header>

<main class="feed" id="main-feed"></main>

<script src="data.js"></script>
<script>
const WORKER_URL = "https://visitor-counter.kokopujiyanto.workers.dev";
const CHANNEL_YOUTUBE = "https://youtube.com/@kokosimaabsurd";
const feedContainer = document.getElementById("main-feed");

/* ==========================
   OPTIMIZED LIKE OBSERVER
========================== */
const likeObserver = new IntersectionObserver((entries, observer) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            const id = entry.target.id;
            fetchLikeCount(id);
            observer.unobserve(entry.target);
        }
    });
}, { threshold: 0.1 });

async function fetchLikeCount(id) {
    const label = document.getElementById(`idx-like-${id}`);
    try {
        const res = await fetch(`${WORKER_URL}/?action=like&imageId=${id}`);
        const result = await res.json();
        if (label) label.innerText = result.likes || 0;
    } catch (e) {
        if (label) label.innerText = "0";
    }
}

/* ==========================
   FEED GENERATOR
========================== */
function generateFeed(keysToRender = null) {
    if (typeof PROMPT_DATABASE === 'undefined') {
        feedContainer.innerHTML = `<div style="text-align:center; padding: 2rem; color: #cc0000;"><h3>Gagal Memuat Data</h3></div>`;
        return;
    }

    feedContainer.innerHTML = "";
    const fragment = document.createDocumentFragment();
    let keys = keysToRender || Object.keys(PROMPT_DATABASE);
    if (!keysToRender) keys = [...keys].reverse();

    if (keys.length === 0) {
        feedContainer.innerHTML = `<div class="no-results"><h3>Prompt tidak ditemukan...</h3></div>`;
        return;
    }

    keys.forEach(id => {
        try {
            const data = PROMPT_DATABASE[id];
            if (!data || !data.title) return;

            const safeText = data.text || ""; 
            const previewText = safeText.split(/\s+/).slice(0, 10).join(" ") + "...";

            const hasVideo = data.videoUrl && data.videoUrl !== "#";
            const btnLabel = hasVideo ? "‚ñ∂ Video" : "üì∫"; 
            const btnHref = hasVideo ? data.videoUrl : CHANNEL_YOUTUBE;

            const section = document.createElement("section");
            section.className = "item";
            section.id = id;
            section.innerHTML = `
                <div class="media-container">
                    <div class="like-badge-index">‚ù§Ô∏è <span id="idx-like-${id}">...</span></div>
                    <img src="images/${id}.webp" alt="${data.title}" loading="lazy" decoding="async"
                    onerror="this.onerror=null;this.src='images/${id}.jpg';">
                </div>
                <div class="content-container">
                    <h3 title="${data.title}">${data.title}</h3>
                    <p class="prompt-preview">${previewText}</p>
                    <div class="actions">
                        <a class="btn btn-primary" href="${btnHref}" target="_blank">${btnLabel}</a>
                        <a class="btn btn-outline" href="prompt.html?id=${id}">PROMPT</a>
                        <button class="btn btn-share" onclick="sharePrompt('${id}')">üîó</button>
                    </div>
                </div>
            `;
            fragment.appendChild(section);
            likeObserver.observe(section);
        } catch (err) { console.error(err); }
    });
    feedContainer.appendChild(fragment);
}

// Search Logic
document.getElementById('searchInput').addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase().trim();
    if (term === "") { generateFeed(); return; }
    const filtered = Object.keys(PROMPT_DATABASE).filter(id => 
        (PROMPT_DATABASE[id].title + PROMPT_DATABASE[id].text).toLowerCase().includes(term)
    );
    generateFeed(filtered);
});

function sharePrompt(id) {
    const url = `${window.location.origin}/prompt.html?id=${id}`;
    if (navigator.share) {
        navigator.share({ title: PROMPT_DATABASE[id].title, url });
    } else {
        window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`);
    }
}

generateFeed();
</script>

<div class="floating-stack">
  <div class="floating-visitor" id="visitorBar">üëÅÔ∏è <span id="visitorToday">0</span> ¬∑ <strong id="visitorTotal">0</strong></div>
  <a href="https://youtube.com/@kokosimaabsurd" class="floating-youtube" target="_blank">‚ñ∂</a>
</div>
<script src="visitor.js" defer></script>
<script src="language.js"></script>
</body>
</html>
